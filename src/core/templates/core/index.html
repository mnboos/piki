{% extends "core/base.html" %}

{% block main %}
    <div class="card p-2">
        <h2>Camera Feed</h2>
        <img id="camera-feed" src="{% url 'video_feed' %}" alt="feed">
        <canvas id="snapshot-canvas" width="640" height="480" style="display: none;"></canvas>

        {#        <video autoplay></video>#}
    </div>
    <div class=" card p-2">
        <h2>Servo Control</h2>
        <form action="{% url 'move_servo' %}" method="post">
            {% csrf_token %}
            <label>
                Tilt ({{ request.session.tilt_position }}°):
                <br>
                <input type="range" name="tilt_position" class="form-range" min="-90" max="90"
                       value="{{ request.session.tilt_position }}">
            </label>
            <br>
            <label>
                Pan ({{ request.session.pan_position }}°):
                <br>
                <input type="range" name="pan_position" class="form-range" min="-90" max="90"
                       value="{{ request.session.pan_position }}">
            </label>
            <br>

            <input type="submit" value="Set Position" class="btn btn-primary">
        </form>
        <hr>
        <h3>Quick Actions</h3>
        <div class="d-flex">
            <form id="formMin" action="{% url 'move_servo' %}" method="post" class="">
                {% csrf_token %}
                <input type="hidden" name="tilt_position" value="-90">
                <input type="hidden" name="pan_position" value="-90">
            </form>
            <form id="formMid" action="{% url 'move_servo' %}" method="post" class="mx-2">
                {% csrf_token %}
                <input type="hidden" name="tilt_position" value="0">
                <input type="hidden" name="pan_position" value="0">
            </form>
            <form id="formMax" action="{% url 'move_servo' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="tilt_position" value="90">
                <input type="hidden" name="pan_position" value="90">
            </form>
            <form id="formRand" action="{% url 'move_servo' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="tilt_position" value="{{ servo_range | random }}">
                <input type="hidden" name="pan_position" value="{{ servo_range | random }}">
            </form>


            <div class="btn-group" role="group" aria-label="Basic example">
                <button type="submit" class="btn btn-outline-primary" form="formMin">Min</button>
                <button type="submit" class="btn btn-outline-primary" form="formMid">Mid</button>
                <button type="submit" class="btn btn-outline-primary" form="formMax">Max</button>
                <button type="submit" class="btn btn-outline-primary" form="formRand">Rand</button>
            </div>


        </div>
        <hr>
        <h3>Stream</h3>
        <!-- This is now a regular button, not a link -->
        <button id="download-button" class="btn btn-primary">Capture Current Frame</button>

        <hr>
        <h3>AI</h3>
        <form action="{% url 'config_ai' %}" method="post">
            {% csrf_token %}
            <label>
                Probability Threshold ({{ request.session.prob_threshold|floatformat:"0" }}%):
                <br>
                <input onchange="this.form.submit()" name="prob_threshold"
                       type="range" class="form-range" min="10" max="100" step="5"
                       value="{{ request.session.prob_threshold }}">
            </label>
        </form>
    </div>

{% endblock %}

{% block footer %}
    <script>
        // Wait for the document to be fully loaded
        document.addEventListener("DOMContentLoaded", () => {

            // Get references to the HTML elements
            const cameraFeed = document.getElementById("camera-feed");
            const downloadButton = document.getElementById("download-button");
            const canvas = document.getElementById("snapshot-canvas");
            const context = canvas.getContext("2d");

            // Add a click event listener to the download button
            downloadButton.addEventListener("click", () => {
                // 1. Draw the current image from the video feed onto the hidden canvas
                // The cameraFeed element acts as a valid source for drawImage
                context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);

                // 2. Convert the canvas content to a Blob (Binary Large Object)
                // This is the modern and recommended way to handle binary data.
                canvas.toBlob((blob) => {
                    // 3. Create a temporary URL for the Blob
                    const url = URL.createObjectURL(blob);

                    // 4. Create a temporary anchor (link) element
                    const tempLink = document.createElement("a");

                    // 5. Set the link's href to our temporary Blob URL
                    tempLink.href = url;

                    // 6. Set the 'download' attribute to suggest a filename
                    tempLink.setAttribute("download", "capture.jpg");

                    // 7. Programmatically click the link to trigger the download
                    tempLink.click();

                    // 8. Clean up by revoking the temporary URL
                    URL.revokeObjectURL(url);

                }, "image/jpeg"); // Specify the format as JPEG
            });
        });
    </script>
{% endblock %}